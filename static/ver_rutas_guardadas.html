<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Rutas Guardadas - Iquique</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; }
        
        .control-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 300px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            max-height: 90vh;
            overflow-y: auto;
        }

        h2 { margin: 0 0 15px 0; font-size: 18px; color: #2c3e50; }
        
        .route-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .route-item {
            padding: 10px;
            border: 1px solid #eee;
            margin-bottom: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .route-item:hover {
            background-color: #f8f9fa;
            border-color: #3498db;
        }

        .route-item.active {
            background-color: #e3f2fd;
            border-color: #2196f3;
            border-left: 4px solid #2196f3;
        }

        .route-info { font-size: 12px; color: #666; margin-top: 4px; }
        .route-id { font-weight: bold; color: #2c3e50; }

        .stats-panel {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            display: none;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .btn-refresh {
            width: 100%;
            padding: 10px;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .btn-refresh:hover { background-color: #27ae60; }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="control-panel">
        <h2>Rutas Guardadas</h2>
        <button class="btn-refresh" onclick="cargarListaRutas()">üîÑ Actualizar Lista</button>
        <div id="lista-rutas" class="route-list">
            Cargando...
        </div>

        <div id="stats-panel" class="stats-panel">
            <h3>Detalles de Ruta</h3>
            <div class="stat-row">
                <span>ID:</span>
                <span id="stat-id">-</span>
            </div>
            <div class="stat-row">
                <span>Distancia:</span>
                <span id="stat-dist">-</span>
            </div>
            <div class="stat-row">
                <span>Duraci√≥n:</span>
                <span id="stat-dur">-</span>
            </div>
            <div class="stat-row">
                <span>Puntos:</span>
                <span id="stat-pts">-</span>
            </div>
        </div>
    </div>

    <script>
        // Inicializar mapa
        const map = L.map('map').setView([-20.2666, -70.1300], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        let currentLayer = null;

        async function cargarListaRutas() {
            const container = document.getElementById('lista-rutas');
            container.innerHTML = '<div style="text-align:center; color:#666;">Cargando...</div>';

            try {
                const response = await fetch('/rutas-planificadas/?limit=50');
                const rutas = await response.json();

                container.innerHTML = '';
                
                if (rutas.length === 0) {
                    container.innerHTML = '<div style="padding:10px; text-align:center;">No hay rutas guardadas</div>';
                    return;
                }

                // Ordenar por ID descendente (m√°s recientes primero)
                rutas.sort((a, b) => b.id_ruta - a.id_ruta);

                rutas.forEach(ruta => {
                    const item = document.createElement('div');
                    item.className = 'route-item';
                    item.onclick = () => cargarDetalleRuta(ruta.id_ruta, item);
                    
                    const fecha = new Date(ruta.fecha).toLocaleDateString();
                    const distValue = ruta.distancia_planificada_km || ruta.distancia_km;
                    const dist = distValue ? `${distValue.toFixed(2)} km` : 'N/A';
                    
                    item.innerHTML = `
                        <div class="route-id">Ruta #${ruta.id_ruta}</div>
                        <div class="route-info">üìÖ ${fecha} | üìè ${dist}</div>
                    `;
                    container.appendChild(item);
                });

            } catch (error) {
                console.error(error);
                container.innerHTML = '<div style="color:red; padding:10px;">Error al cargar rutas</div>';
            }
        }

        async function cargarDetalleRuta(id, element) {
            // Highlight selection
            document.querySelectorAll('.route-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');

            try {
                const response = await fetch(`/rutas-planificadas/${id}`);
                const ruta = await response.json();

                mostrarEnMapa(ruta);
                actualizarStats(ruta);

            } catch (error) {
                console.error(error);
                alert('Error al cargar detalles de la ruta');
            }
        }

        function mostrarEnMapa(ruta) {
            if (currentLayer) {
                map.removeLayer(currentLayer);
            }

            if (!ruta.geometria_json || ruta.geometria_json.length === 0) {
                alert('Esta ruta no tiene geometr√≠a guardada');
                return;
            }

            // La geometr√≠a viene como [[lat, lon], ...]
            // Leaflet Polyline acepta [lat, lon]
            const latlngs = ruta.geometria_json;

            currentLayer = L.layerGroup();

            // Dibujar l√≠nea
            const polyline = L.polyline(latlngs, {
                color: '#e74c3c',
                weight: 5,
                opacity: 0.8,
                lineJoin: 'round'
            }).addTo(currentLayer);

            // Dibujar inicio (Depot)
            L.circleMarker(latlngs[0], {
                radius: 8,
                fillColor: '#2ecc71',
                color: '#fff',
                weight: 2,
                fillOpacity: 1
            }).bindPopup('Inicio').addTo(currentLayer);

            // Dibujar fin
            L.circleMarker(latlngs[latlngs.length - 1], {
                radius: 8,
                fillColor: '#e74c3c',
                color: '#fff',
                weight: 2,
                fillOpacity: 1
            }).bindPopup('Fin').addTo(currentLayer);

            currentLayer.addTo(map);
            map.fitBounds(polyline.getBounds(), { padding: [50, 50] });
        }

        function actualizarStats(ruta) {
            document.getElementById('stats-panel').style.display = 'block';
            document.getElementById('stat-id').textContent = ruta.id_ruta;
            
            const distValue = ruta.distancia_planificada_km || ruta.distancia_km;
            document.getElementById('stat-dist').textContent = distValue ? `${distValue.toFixed(2)} km` : 'N/A';
            
            const durValue = ruta.duracion_planificada_min || ruta.tiempo_estimado_min;
            document.getElementById('stat-dur').textContent = durValue ? `${durValue.toFixed(1)} min` : 'N/A';
            
            document.getElementById('stat-pts').textContent = ruta.secuencia_puntos ? ruta.secuencia_puntos.length : '0';
        }

        // Cargar al inicio
        cargarListaRutas();
    </script>
</body>
</html>
