<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Integral: LSTM + MAS + VRP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        .panel {
            position: absolute;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 20px;
            z-index: 1000;
        }
        
        .panel-config {
            top: 20px;
            right: 20px;
            width: 350px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .panel-stats {
            bottom: 20px;
            left: 20px;
            width: 300px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        h2 { 
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        h3 {
            color: #34495e;
            margin: 15px 0 10px 0;
            font-size: 14px;
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-size: 13px;
            font-weight: 500;
        }
        
        input[type="number"],
        input[type="date"],
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(56, 239, 125, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(235, 51, 73, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-box.green {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .stat-box.blue {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .stat-box.orange {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 11px;
            opacity: 0.9;
            text-transform: uppercase;
        }
        
        .alert {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 13px;
        }
        
        .alert-info {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #1976d2;
        }
        
        .alert-success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }
        
        .alert-warning {
            background: #fff3e0;
            color: #ef6c00;
            border-left: 4px solid #ff9800;
        }
        
        .legend {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .legend-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid #333;
        }
        
        .truck-list {
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .truck-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 8px;
            border-left: 4px solid #3498db;
        }
        
        .truck-item strong {
            color: #2c3e50;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- Panel de Configuración -->
    <div class="panel panel-config">
        <h2>Sistema Integral de Recolección</h2>
        
        <div class="alert alert-info">
            <strong>Paso 1:</strong> Selecciona fecha y carga predicciones LSTM
        </div>
        
        <h3>1. Predicciones LSTM</h3>
        <div class="form-group">
            <label for="fechaPrediccion">Fecha de Recolección:</label>
            <input type="date" id="fechaPrediccion">
        </div>
        
        <button class="btn btn-primary" onclick="cargarPredicciones()">
            Cargar Puntos de Basura
        </button>
        
        <div id="estadoPredicciones"></div>
        
        <h3>2. Configuración de Camiones</h3>
        <div class="form-group">
            <label for="numCamiones">Número de Camiones:</label>
            <input type="number" id="numCamiones" value="3" min="1" max="10">
        </div>
        
        <div class="form-group">
            <label for="capacidadCamion">Capacidad por Camión (kg):</label>
            <input type="number" id="capacidadCamion" value="3500" min="1000" max="10000" step="100">
        </div>
        
        <button class="btn btn-success" id="btnIniciar" onclick="iniciarMonitoreo()" disabled>
            Iniciar Simulación
        </button>
        
        <button class="btn btn-danger" id="btnDetener" onclick="detenerMonitoreo()" disabled>
            Detener Simulación
        </button>
        
        <div class="legend">
            <h3>Leyenda</h3>
            <div class="legend-item">
                <div class="legend-icon" style="background: #2ecc71;"></div>
                <span>Baja (< 80 kg)</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background: #f39c12;"></div>
                <span>Media (80-120 kg)</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background: #e74c3c;"></div>
                <span>Alta (> 120 kg)</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background: #3498db;"></div>
                <span>Vertedero</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background: #8e44ad;"></div>
                <span>Base Operaciones</span>
            </div>
        </div>
    </div>
    
    <!-- Panel de Estadísticas -->
    <div class="panel panel-stats">
        <h2>Estadísticas en Tiempo Real</h2>
        
        <div class="stat-grid">
            <div class="stat-box green">
                <div class="stat-value" id="kgRecolectados">0</div>
                <div class="stat-label">KG Recolectados</div>
            </div>
            <div class="stat-box blue">
                <div class="stat-value" id="puntosServidos">0/0</div>
                <div class="stat-label">Puntos Servidos</div>
            </div>
            <div class="stat-box orange">
                <div class="stat-value" id="tiempoTotal">00:00</div>
                <div class="stat-label">Tiempo Total</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="paso">0</div>
                <div class="stat-label">Paso Actual</div>
            </div>
        </div>
        
        <h3>Estado de Camiones</h3>
        <div class="truck-list" id="listaCamiones">
            <p style="color: #999; font-size: 12px;">Inicia la simulación para ver camiones</p>
        </div>
    </div>
    
    <script>
        // ==================== VARIABLES GLOBALES ====================
        const API_BASE_URL = 'http://localhost:8000/bridge';
        const map = L.map('map').setView([-20.245, -70.09], 13);
        let monitoreoActivo = false;
        let intervalId = null;
        let marcadoresPuntos = {};
        let capasCamiones = {};
        let capasRutas = {}; // Ya no se usa para líneas futuras, sino para rastros
        let rastrosCamiones = {}; // Nueva variable para el historial de posiciones
        
        // Colores para camiones
        const coloresCamiones = [
            '#e74c3c', '#3498db', '#2ecc71', '#9b59b6', '#f1c40f', '#e67e22', '#1abc9c'
        ];
        
        // ==================== INICIALIZAR MAPA ====================
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        // Círculo de cobertura
        L.circle([-20.2666, -70.1300], {
            color: '#3498db',
            fillColor: '#3498db',
            fillOpacity: 0.1,
            radius: 5000,
            weight: 2
        }).addTo(map);
        
        // --- MARCADORES INICIALES (Base y Vertedero) ---
        
        // 1. Base de Operaciones (Inicio)
        const baseMarker = L.marker([-20.29305111963256, -70.12295105323292], {
            icon: L.divIcon({
                className: 'base-icon',
                html: '<div style="background: #8e44ad; width: 30px; height: 30px; border-radius: 5px; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); display:flex; justify-content:center; align-items:center; color:white; font-weight:bold;">B</div>',
                iconSize: [30, 30]
            })
        }).bindPopup('<b>Base de Operaciones</b><br>Inicio/Fin de Turno').addTo(map);

        // 2. Vertedero (Depot/Descarga)
        const vertederoMarker = L.marker([-20.19767564535899, -70.06207963576485], {
            icon: L.divIcon({
                className: 'depot-icon',
                html: '<div style="background: #3498db; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                iconSize: [30, 30]
            })
        }).bindPopup('<b>Vertedero</b><br>Punto de Disposición Final').addTo(map);
        
        // ==================== FECHA POR DEFECTO ====================
        const mañana = new Date();
        mañana.setDate(mañana.getDate() + 1);
        document.getElementById('fechaPrediccion').valueAsDate = mañana;
        
        // ==================== FUNCIÓN: CARGAR PREDICCIONES ====================
        async function cargarPredicciones() {
            const fecha = document.getElementById('fechaPrediccion').value;
            const estadoDiv = document.getElementById('estadoPredicciones');
            
            if (!fecha) {
                estadoDiv.innerHTML = '<div class="alert alert-warning">Por favor selecciona una fecha</div>';
                return;
            }
            
            estadoDiv.innerHTML = '<div class="alert alert-info loading">Inicializando simulación y cargando puntos LSTM...</div>';
            
            try {
                const numCamiones = parseInt(document.getElementById('numCamiones').value) || 3;
                
                // 1. Inicializar Simulación en el Backend (Carga puntos desde LSTM)
                const initResponse = await fetch(`${API_BASE_URL}/init`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        fecha: fecha,
                        num_camiones: numCamiones
                    })
                });
                
                const initData = await initResponse.json();
                
                if (!initResponse.ok || initData.status !== 'success') {
                    throw new Error(initData.message || 'Error inicializando simulación');
                }

                // 2. Obtener estado inicial para visualizar
                const response = await fetch(`${API_BASE_URL}/world/state`);
                const data = await response.json();
                
                if (response.ok) {
                    // Limpiar marcadores anteriores
                    Object.values(marcadoresPuntos).forEach(m => map.removeLayer(m));
                    marcadoresPuntos = {};
                    
                    // Dibujar puntos pendientes
                    data.puntos_pendientes.forEach(p => {
                        const color = getColorPorDemanda(p.demanda);
                        const radio = getRadioPorDemanda(p.demanda);
                        const pId = `punto_${p.id}`;
                        
                        marcadoresPuntos[pId] = L.circleMarker([p.lat, p.lon], {
                            radius: radio,
                            fillColor: color,
                            color: '#333',
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.7
                        }).bindPopup(`
                            <div style="min-width: 200px;">
                                <h4 style="margin: 0 0 10px 0; color: ${color};">${p.nombre || 'Punto ' + p.id} (ID: ${p.id})</h4>
                                <p style="margin: 5px 0;">
                                    <b>Predicción:</b> <span style="color: ${color}; font-size: 16px; font-weight: bold;">
                                        ${Math.round(p.demanda)} kg
                                    </span><br>
                                    <b>Fecha:</b> ${fecha}<br>
                                    <b>Coordenadas:</b> ${p.lat.toFixed(4)}, ${p.lon.toFixed(4)}
                                </p>
                            </div>
                        `).addTo(map);
                    });
                    
                    estadoDiv.innerHTML = `<div class="alert alert-success">
                        <strong>Listo!</strong> ${data.puntos_pendientes.length} puntos cargados y listos para JADE.
                    </div>`;
                    
                    document.getElementById('btnIniciar').disabled = false;
                }
                
            } catch (error) {
                console.error('Error:', error);
                estadoDiv.innerHTML = `<div class="alert alert-warning">Error: ${error.message}</div>`;
            }
        }
        
        // ==================== FUNCIONES DE MONITOREO ====================
        
        function iniciarMonitoreo() {
            monitoreoActivo = true;
            document.getElementById('btnIniciar').disabled = true;
            document.getElementById('btnDetener').disabled = false;
            
            // Actualizar inmediatamente y luego cada 2 segundos
            actualizarEstado();
            intervalId = setInterval(actualizarEstado, 2000);
        }
        
        function detenerMonitoreo() {
            monitoreoActivo = false;
            document.getElementById('btnIniciar').disabled = false;
            document.getElementById('btnDetener').disabled = true;
            
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
        }
        
        function actualizarEstado() {
            if (!monitoreoActivo) return;
            
            fetch(`${API_BASE_URL}/world/state`)
                .then(response => response.json())
                .then(data => {
                    actualizarCamionesEnMapa(data.camiones);
                    actualizarListaCamiones(data.camiones);
                    actualizarEstadisticas(data);
                    
                    // Actualizar puntos servidos (cambiar a gris)
                    if (data.puntos_servidos) {
                        data.puntos_servidos.forEach(pid => {
                            const markerId = `punto_${pid}`;
                            if (marcadoresPuntos[markerId]) {
                                marcadoresPuntos[markerId].setStyle({
                                    fillColor: '#95a5a6', // Gris
                                    color: '#7f8c8d',
                                    fillOpacity: 0.4
                                });
                            }
                        });
                    }
                })
                .catch(error => console.error('Error polling:', error));
        }
        
        function actualizarCamionesEnMapa(camionesDict) {
            const camiones = Object.values(camionesDict);
            
            camiones.forEach((camion, index) => {
                const camionId = `camion_${camion.id_db}`;
                const color = coloresCamiones[index % coloresCamiones.length];
                const posActual = [camion.lat, camion.lon];

                // RASTRO (Trail) - Historial de movimiento
                if (!rastrosCamiones[camionId]) {
                    rastrosCamiones[camionId] = L.polyline([posActual], {
                        color: color,
                        weight: 4,
                        opacity: 0.6,
                        lineJoin: 'round'
                    }).addTo(map);
                } else {
                    rastrosCamiones[camionId].addLatLng(posActual);
                }
                
                // MARCADOR
                if (capasCamiones[camionId]) {
                    capasCamiones[camionId].setLatLng(posActual);
                    capasCamiones[camionId].getPopup().setContent(generarPopupCamion(camion, color));
                    capasCamiones[camionId].bringToFront(); // Asegurar que esté encima
                } else {
                    capasCamiones[camionId] = L.circleMarker(posActual, {
                        radius: 14, // Un poco más grande
                        fillColor: color,
                        color: '#fff',
                        weight: 3,
                        opacity: 1,
                        fillOpacity: 1,
                        zIndexOffset: 1000 // Alta prioridad visual
                    }).bindPopup(generarPopupCamion(camion, color)).addTo(map);
                }
            });
        }
        
        function generarPopupCamion(camion, color) {
            return `<b>${camion.patente}</b><br>Carga: ${Math.round(camion.carga)} kg`;
        }
        
        function actualizarListaCamiones(camionesDict) {
            const container = document.getElementById('listaCamiones');
            const camiones = Object.values(camionesDict);
            
            if (camiones.length === 0) {
                container.innerHTML = '<p style="color: #999; font-size: 12px;">Esperando agentes...</p>';
                return;
            }
            
            container.innerHTML = camiones.map((c, i) => `
                <div class="truck-item" style="border-left-color: ${coloresCamiones[i % coloresCamiones.length]}">
                    <strong>${c.patente}</strong><br>
                    <small>Carga: ${Math.round(c.carga)} kg | Puntos: ${c.ruta ? c.ruta.length : 0}</small>
                </div>
            `).join('');
        }
        
        function actualizarEstadisticas(data) {
            const camiones = Object.values(data.camiones);
            const cargaTotal = camiones.reduce((sum, c) => sum + c.carga, 0);
            
            document.getElementById('kgRecolectados').textContent = Math.round(cargaTotal);
            document.getElementById('puntosServidos').textContent = `${data.puntos_pendientes.length} pend.`;
        }
        
        // Helpers de color/radio
        function getColorPorDemanda(kg) {
            if (kg < 80) return '#2ecc71';
            if (kg < 120) return '#f39c12';
            return '#e74c3c';
        }
        
        function getRadioPorDemanda(kg) {
            return Math.max(5, Math.min(15, kg / 10));
        }
    </script>
</body>
</html>
